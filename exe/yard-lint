#!/usr/bin/env ruby
# frozen_string_literal: true

$LOAD_PATH.unshift File.expand_path('../lib', __dir__)

require 'optparse'
require 'yard/lint'

options = {}
config_file = nil
config_overrides = {}

OptionParser.new do |opts|
  opts.banner = "Usage: yard-lint [options] PATH"

  opts.on('-c', '--config FILE', 'Path to config file (default: .yard-lint.yml)') do |file|
    config_file = file
  end

  opts.on('-t', '--tags-order ORDER', Array,
          'Comma-separated list of tag names in expected order') do |order|
    config_overrides[:tags_order] = order
  end

  opts.on('-e', '--extra-types TYPES', Array,
          'Comma-separated list of extra allowed type names') do |types|
    config_overrides[:extra_types] = types
  end

  opts.on('-o', '--options OPTIONS', Array,
          'Comma-separated list of extra YARD options') do |yard_options|
    config_overrides[:options] = yard_options
  end

  opts.on('-x', '--exclude PATTERNS', Array,
          'Comma-separated list of exclusion patterns') do |patterns|
    config_overrides[:exclude] = patterns
  end

  opts.on('-s', '--fail-on-severity LEVEL',
          'Fail on severity level (error, warning, convention, never)') do |level|
    config_overrides[:fail_on_severity] = level
  end

  opts.on('-f', '--format FORMAT', 'Output format (text, json)') do |format|
    options[:format] = format
  end

  opts.on('-q', '--quiet', 'Quiet mode (only show summary)') do
    options[:quiet] = true
  end

  opts.on('--stats', 'Show statistics summary') do
    options[:stats] = true
  end

  opts.on('-v', '--version', 'Show version') do
    puts "yard-lint #{Yard::Lint::VERSION}"
    exit
  end

  opts.on('-h', '--help', 'Show this help') do
    puts opts
    exit
  end
end.parse!

# Load config from file or auto-detect, then apply CLI overrides
config = Yard::Lint.load_config(config_file)
config_overrides.each do |key, value|
  config.send("#{key}=", value)
end

# Get path argument
path = ARGV[0]

unless path
  puts 'Error: PATH argument is required'
  puts 'Usage: yard-lint [options] PATH'
  exit 1
end

# Run the linter (passing config directly since we already loaded it)
result = Yard::Lint.run(path: path, config: config, config_file: false)

# Format and display results
case options[:format]
when 'json'
  require 'json'
  puts JSON.pretty_generate({
                              offense_count: result.count,
                              offenses: result.offenses
                            })
  exit result.exit_code(config)
when 'text', nil
  if result.clean?
    puts 'âœ“ No offenses found'
    exit 0
  else
    # Show statistics if requested or in quiet mode
    if options[:stats] || options[:quiet]
      stats = result.statistics
      puts "\n#{result.count} offense(s) detected"
      puts "  Errors:      #{stats[:error]}"
      puts "  Warnings:    #{stats[:warning]}"
      puts "  Conventions: #{stats[:convention]}"
      puts
    end

    # Show individual offenses unless in quiet mode
    unless options[:quiet]
      puts "Found #{result.count} offense(s):\n\n"

      result.offenses.each do |offense|
        severity_symbol = case offense[:severity]
                          when 'error' then 'E'
                          when 'warning' then 'W'
                          when 'convention' then 'C'
                          else '?'
                          end

        puts "[#{severity_symbol}] #{offense[:location]}:#{offense[:location_line]}"
        puts "    #{offense[:name]}: #{offense[:message]}"
        puts
      end
    end

    exit result.exit_code(config)
  end
else
  puts "Error: Unknown format '#{options[:format]}'"
  exit 1
end
